---
title: Exploring US Census Data with Visualization
author: Satvika Upperla
tutorial:
  id: wrangling-census-data-with-tidyverse-tools
output:
  learnr::tutorial:
    progressive: yes
    allow_skip: yes
runtime: shiny_prerendered
description: 'Tutorial for Chapter 4: Wrangling Census data with tidyverse tools'
---

```{r setup, include = FALSE}
library(learnr)
library(tutorial.helpers)
library(tidycensus)
library(tidyverse)
library(knitr)
library(scales             )

knitr::opts_chunk$set(echo = FALSE)
options(tutorial.exercise.timelimit = 60, 
        tutorial.storage = "local") 

# We want the tutorial to run even if students do not have an internet
# connection, so we need to save all the downloaded data. Save the creation code
# to make replication/improvements easier.

# maine_income <- get_acs(
#  state = "Maine",
#  geography = "county",
#  variables = c(hhincome = "B19013_001"),
#  year = 2020
#) |>
#  mutate(NAME = str_remove(NAME, " County, Maine"))
# write_rds(maine_income, "data/main_income.rds")
 maine_income <- read_rds( "data/main_income.rds")


# years <- 2005:2019
#names(years) <- years

#deschutes_value <- map_dfr(years, ~{
 # get_acs(
 #   geography = "county",
 #   variables = "B25077_001",
  #  state = "OR",
  #  county = "Deschutes",
 #   year = .x,
 #   survey = "acs1"
 # )
#}, .id = "year")
#  write_rds(deschutes_value, "data/deschutes_value.rds")
 read_rds("data/deschutes_value.rds")
  
  

  
  
   # utah <- get_estimates(
 # geography = "state",
 #  state = "UT",
 # product = "characteristics",
 # breakdown = c("SEX", "AGEGROUP"),
 # breakdown_labels = TRUE,
 # year = 2019
#) 
 # write_rds(utah, "data/utah.rds")
  read_rds("data/utah.rds")
  
 # utah_filtered <- filter(utah, str_detect(AGEGROUP, "^Age"), 
 #                SEX != "Both sexes") |>
  #mutate(value = ifelse(SEX == "Male", -value, value))
  
#  write_rds(utah_filtered, "data/utah_filtered.rds")
  read_rds("data/utah_filtered.rds")
  
  
  
 # housing_val <- get_acs(
  #geography = "tract", 
  #variables = "B25077_001", 
  #state = "OR", 
#  county = c(
 #   "Multnomah", 
  #  "Clackamas", 
   # "Washington",
    #"Yamhill", 
  #  "Marion", 
  #  "Columbia"
  #),
  #year = 2020
#)
  
#write_rds(housing_val, "data/housing_val.rds")
read_rds("data/housing_val.rds")

#housing_val2 <- separate(
 # housing_val, 
  #NAME, 
  #into = c("tract", "county", "state"), 
  #sep = ", "
#)
#write_rds(housing_val2, "data/housing_val2.rds")
read_rds("data/housing_val2.rds")
```

```{r copy-code-chunk, child = system.file("child_documents/copy_button.Rmd", package = "tutorial.helpers")}
```

```{r info-section, child = system.file("child_documents/info_section.Rmd", package = "tutorial.helpers")}
```

This tutorial covers [Chapter 4: Exploring US Census data with visualization](https://walker-data.com/census-r/exploring-us-census-data-with-visualization.html#visualizing-margins-of-error) from [*Analyzing US Census Data: Methods, Maps, and Models in R*](https://walker-data.com/census-r/index.html) by Kyle Walker. You will learn about the [**ggplot**] and [**plotly**] package and mapping and using it to visualize moes (margin of error)

## Visualizing Margins of Error
###

The [tidyverse](https://tidyverse.tidyverse.org/) is a collection of R packages that are designed to work together in common data wrangling, analysis, and visualization projects. Many of these R packages, maintained by RStudio, are among the most popular R packages worldwide.

### Exercise 1

Load in **tidyverse** package. 

```{r visualizing-margins-of-error-1, exercise = TRUE}

```

```{r visualizing-margins-of-error-1-hint-1, eval = FALSE}
library(...)
```

```{r visualizing-margins-of-error-1-test, include = FALSE}
library(tidyverse)
```

The **tidyverse** is not really a package itself, but, rather, loads several core packages.

### Exercise 2

We can access the US Census API via the **tidycensus** package. The **tidycensus** package utilizes an API key to access Census data. Load the **tidycensus** package into your R session.

Run `search()` in the Console to see the libraries that you've currently loaded. CP/CR.

```{r visualizing-margins-of-error-2}
question_text(NULL,
    answer(NULL, correct = TRUE),
    allow_retry = TRUE,
    try_again_button = "Edit Answer",
    incorrect = NULL,
    rows = 3)
```

### 

The output should include the string "package:tidycensus". Kyle Walker is also the author of the [**tidycensus**](https://walker-data.com/tidycensus/) package.

### Exercise 3
In the example below, we will compare the median household incomes of counties in the US state of Maine from the 2016-2020 ACS.
Use the function `get_decennial()` and passing in `state = "Maine"`,
  `geography = "county"`,
  `variables = c(totalpop = "P1_001N")`, and 
  `year = 2020` as arguments
 
```{r visualizing-margins-of-error-3, exercise = TRUE}

```

```{r visualizing-margins-of-error-3-hint-1, eval = FALSE}
get_decennial(
  state = ...,
  ... = "county",
  variables = c(... = "P1_001N"),
  year = 2020
) 
```

### Exercise 4
Pipe the previous code into the function  `arrange()` with `desc(value)` as an argument/
 
```{r visualizing-margins-of-error-4, exercise = TRUE}

```

<!-- SU: Need copy code button -->

```{r visualizing-margins-of-error-4-hint-1, eval = FALSE}
get_decennial(
  state = ...,
  ... = "county",
  variables = c(... = "P1_001N"),
  year = 2020
) |>
   arrange(...(value))
```

There are sixteen counties in Maine, ranging in population from a maximum of 303,069 to a minimum of 16,800. In turn, estimates for the counties with smaller population sizes are likely to be subject to a larger margin of error than those with larger baseline populations.

### Exercise 5

Comparing median household incomes of these sixteen counties illustrates this point. Letâ€™s first obtain this data with tidycensus then clean up the NAME column with str_remove() to remove redundant information.
Delete the `arrange()` and anything within in it and replace it with the `mutate()` function and pass in `NAME = str_remove()` as the argument. withing `str_remove()` pass in `NAME, " County, Maine"` as an argument. 
 
```{r visualizing-margins-of-error-5, exercise = TRUE}

```

<!-- SU: Need copy code button here -->

```{r visualizing-margins-of-error-5-hint-1, eval = FALSE}
get_decennial(
  state = ...,
  ... = "county",
  variables = c(... = "P1_001N"),
  year = 2020
) |>
   mutate(NAME = ....(..., " County, Maine"))
```

This will clean up the NAME column replacing something like "York County, Maine" with just "York" instead.

### Exercise 6

We have assigned the previous code to the variable `main_income`. Print `main_income` to ensure it works.

```{r visualizing-margins-of-error-6, exercise = TRUE}

```

```{r visualizing-margins-of-error-6-hint-1, eval = FALSE}
maine_income
```

```{r visualizing-margins-of-error-6-test, include = FALSE}
maine_income
```

### Exercise 7
Several county estimates on the chart are quite close to one another, which may mean that the ranking of counties is misleading given the margin of error around those estimates. Inspect the moe of these counties more. Pipe `main_income` to  `arrange(desc(moe))`

```{r visualizing-margins-of-error-7, exercise = TRUE}

```

<!-- SU: Need copy code button here -->

```{r visualizing-margins-of-error-7-hint-1, eval = FALSE}
maine_income |>
  ...(desc(...))
```

```{r visualizing-margins-of-error-7-test, include = FALSE}
maine_income |>
  arrange(desc(moe))
```

### Exercise 8
Lets visualize the moe's of this data using ggplot. Pipe `main_income` to `ggplot()` setting `x` equal to `estimate` and `y` equal to `reoorder(NAME, estimate)` within `aes`.

```{r visualizing-margins-of-error-8, exercise = TRUE}

```

```{r visualizing-margins-of-error-8-hint-1, eval = FALSE}
ggplot(..., aes(x = ..., y = reorder(NAME, ...)))
```

```{r visualizing-margins-of-error-8-test, include = FALSE}
ggplot(maine_income, aes(x = estimate, y = reorder(NAME, estimate)))
```

### Exercise 9

Add `geom_point` setting `size` to `3` and `color` to `"darkgreen"` within the function

```{r visualizing-margins-of-error-9, exercise = TRUE}

```

<!-- SU:Need copy code button here -->

```{r visualizing-margins-of-error-9-hint-1, eval = FALSE}
ggplot(..., aes(x = ..., y = reorder(NAME, ...))) +  
  geom_point(... = 3, color =  ...)
```

```{r visualizing-margins-of-error-9-test, include = FALSE}
ggplot(maine_income, aes(x = estimate, y = reorder(NAME, estimate))) +  
  geom_point(size = 3, color = "darkgreen")
```

### Exercise 10


```{r visualizing-margins-of-error-10, exercise = TRUE}

```

<!-- SU:Need copy code button here -->

```{r visualizing-margins-of-error-10-hint-1, eval = FALSE}
ggplot(..., aes(x = ..., y = reorder(NAME, ...))) +  
  geom_point(... = 3, color =  ...)
```

```{r visualizing-margins-of-error-10-test, include = FALSE}
ggplot(maine_income, aes(x = estimate, y = reorder(NAME, estimate))) +  
  geom_point(size = 3, color = "darkgreen")
```

A dot plot like the one above intended to visualize a ranking of county household incomes in Maine may be misleading. However, using visualization tools in ggplot2, we can visualize the uncertainty around each estimate, giving chart readers a sense of the uncertainty in the ranking.

### Exercise 11
 Lets add `geom_errorbar()` to visualize the margin of uncertainty. Pipe the previous code to `geom_errorbarh()` setting `xmin` equal to `estimate` minus `moe` and `xmax` to `estimate` plus `moe` within `aes()`.
 

```{r visualizing-margins-of-error-11, exercise = TRUE}

```

<!-- SU:Need copy code button here -->

```{r visualizing-margins-of-error-11-hint-1, eval = FALSE}
ggplot(..., aes(x = ..., y = reorder(NAME, ...))) +  
  geom_point(... = 3, color =  ...) + 
  ...(aes(xmin = ... - moe, xmax = estimate + ...))
```

```{r visualizing-margins-of-error-11-test, include = FALSE}
ggplot(maine_income, aes(x = estimate, y = reorder(NAME, estimate))) +  
  geom_point(size = 3, color = "darkgreen") + 
  geom_errorbarh(aes(xmin = estimate - moe, xmax = estimate + moe))
```

Adding the horizontal error bars around each point gives us critical information to help us understand how our ranking of Maine counties by median household income.

### Exercise 12
Lets make the plot look nice using `labs()` and `theme_minimal()`. Pipe to `theme_minimal()` setting `base_size` to `12.5`. USing labs add a title, subtitle, x, and y.

```{r visualizing-margins-of-error-12, exercise = TRUE}

```

<!-- SU:Need copy code button here -->

```{r visualizing-margins-of-error-12-hint-1, eval = FALSE}
ggplot(..., aes(x = ..., y = reorder(NAME, ...))) +  
  geom_point(... = 3, color =  ...) + 
  ...(aes(xmin = ... - moe, xmax = estimate + ...)) + 
  theme_minimal(... = 12.5) + 
  labs(title = ..., 
      ... = "Counties in Maine", 
       x = "2016-2020 ACS estimate", 
       y = ...)
```

```{r visualizing-margins-of-error-12-test, include = FALSE}
ggplot(maine_income, aes(x = estimate, y = reorder(NAME, estimate))) +  
  geom_point(size = 3, color = "darkgreen") + 
  geom_errorbarh(aes(xmin = estimate - moe, xmax = estimate + moe)) + 
  theme_minimal(base_size = 12.5) + 
  labs(title = "Median household income", 
       subtitle = "Counties in Maine", 
       x = "2016-2020 ACS estimate", 
       y = "")
```

Remember the plot should look like this

<!-- SU: add image of the plot so they can copy label stuff -->

### Exercise 13

Lets make the numbers on the x=axis neater. Pipe the previous code into `scale_x_continuous()` setting `labels = label_dollar()` as the argument

```{r visualizing-margins-of-error-13, exercise = TRUE}

```

<!-- SU:Need copy code button here -->

```{r visualizing-margins-of-error-13-hint-1, eval = FALSE}
ggplot(..., aes(x = ..., y = reorder(NAME, ...))) +  
  geom_point(... = 3, color =  ...) + 
  ...(aes(xmin = ... - moe, xmax = estimate + ...)) + 
  theme_minimal(... = 12.5) + 
  labs(title = ..., 
      ... = "Counties in Maine", 
       x = "2016-2020 ACS estimate", 
       y = ...) + 
  scale_x_continuous(labels = ...)
```

```{r visualizing-margins-of-error-13-test, include = FALSE}
ggplot(maine_income, aes(x = estimate, y = reorder(NAME, estimate))) +  
  geom_point(size = 3, color = "darkgreen") + 
  geom_errorbarh(aes(xmin = estimate - moe, xmax = estimate + moe)) + 
  theme_minimal(base_size = 12.5) + 
  labs(title = "Median household income", 
       subtitle = "Counties in Maine", 
       x = "2016-2020 ACS estimate", 
       y = "") + 
  scale_x_continuous(labels = label_dollar())
```







```{r download-answers, child = system.file("child_documents/download_answers.Rmd", package = "tutorial.helpers")}
```
